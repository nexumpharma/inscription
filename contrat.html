<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Signature du contrat</title>
  <style>
    body {
      font-family: monospace;
      padding: 2rem;
      background: #f5f5f5;
    }
    #logs {
      background: #111;
      color: #0f0;
      padding: 1rem;
      border-radius: 6px;
      white-space: pre-wrap;
      height: 70vh;
      overflow-y: auto;
    }
    #pdf-link {
      margin-top: 1rem;
      display: none;
    }
  </style>
</head>
<body>
  <h1>ğŸ—‘ï¸ GÃ©nÃ©ration du contrat</h1>
  <div id="logs">[ğŸŸ¢] Initialisationâ€¦</div>
  <a id="pdf-link" href="#" target="_blank">ğŸ“„ Voir le contrat gÃ©nÃ©rÃ©</a>

  <script type="module">
    import { supabase, checkAndRestoreSessionFromURL } from './js/auth.js';
    import { SUPABASE_FUNCTION_BASE } from './js/config.js';

    const logs = document.getElementById("logs");
    const link = document.getElementById("pdf-link");

    const log = (msg) => {
      logs.textContent += `\n${msg}`;
      logs.scrollTop = logs.scrollHeight;
    };

    async function run() {
      log("[ğŸ”] Connexion en cours...");
      await checkAndRestoreSessionFromURL();

      const { data: { user }, error } = await supabase.auth.getUser();
      if (!user || error) {
        log("[âŒ] Utilisateur non connectÃ©.");
        return;
      }

      const session = await supabase.auth.getSession();
      const token = session.data.session.access_token;
      if (!token) {
        log("[âŒ] Token Supabase introuvable.");
        return;
      }

      log(`[ğŸ‘¤] ConnectÃ© en tant que ${user.email}`);
      log("[ğŸ›°] RÃ©cupÃ©ration des donnÃ©es pharmacieâ€¦");

      const record = await fetch(`${SUPABASE_FUNCTION_BASE}/get-pharmacie`, {
        headers: { Authorization: `Bearer ${token}` }
      }).then(r => r.json());

      const allFields = record?.records?.[0]?.fields;
      if (!allFields) {
        log("[âŒ] DonnÃ©es pharmacie introuvables.");
        return;
      }

      // âœ… Champs requis par le Google Docs
      const allowedKeys = [
        "CivilitÃ©",
        "PrÃ©nom",
        "Nom",
        "Mail du titulaire",
        "Portable du titulaire",
        "Raison sociale",
        "Nom commercial",
        "Mail de la pharmacie",
        "TÃ©lÃ©phone de la pharmacie",
        "Adresse",
        "Code postal",
        "Ville"
      ];

      const fields = Object.fromEntries(
        allowedKeys.map(k => [k, allFields[k] ?? ""])
      );

      log("[ğŸ§ª JSON envoyÃ©] " + JSON.stringify(fields, null, 2));
      log("[ğŸ“¤] Envoi des donnÃ©es Ã  trigger-google-pdfâ€¦");

      const res = await fetch(`${SUPABASE_FUNCTION_BASE}/trigger-google-pdf`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ fields })
      });

      const data = await res.json();

      if (res.ok && data?.success) {
        log("[âœ…] Contrat gÃ©nÃ©rÃ© avec succÃ¨s !");
        log(`[ğŸ“„] ID PDF : ${data.pdfFileId}`);
        log(`[ğŸ”—] URL : ${data.pdfUrl}`);

        link.href = data.pdfUrl;
        link.style.display = "inline-block";
        link.textContent = "ğŸ“„ Voir le contrat gÃ©nÃ©rÃ©";
      } else {
        log("[âŒ] Ã‰chec :");
        log(JSON.stringify(data, null, 2));
      }
    }

    run();
  </script>
</body>
</html>
