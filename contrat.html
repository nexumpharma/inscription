<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Signature du contrat</title>
  <style>
    body {
      font-family: monospace;
      padding: 2rem;
      background: #f5f5f5;
    }
    #logs, #text-output {
      background: #111;
      color: #0f0;
      padding: 1rem;
      border-radius: 6px;
      white-space: pre-wrap;
      height: auto;
      max-height: 60vh;
      overflow-y: auto;
      margin-top: 1rem;
    }
    #pdf-link, #download-link {
      margin-top: 1rem;
      display: none;
      margin-right: 1rem;
    }
  </style>
</head>
<body>
  <h1>ğŸ“ GÃ©nÃ©ration et affichage du contrat</h1>
  <div id="logs">[ğŸŸ¢] Initialisationâ€¦</div>
  <a id="pdf-link" href="#" target="_blank">ğŸ“„ Voir le contrat gÃ©nÃ©rÃ©</a>
  <a id="download-link" href="#" download="contrat.pdf">â¬‡ï¸ TÃ©lÃ©charger le contrat en PDF</a>
  <pre id="text-output">[ğŸ“„] Le contenu du contrat sâ€™affichera iciâ€¦</pre>

  <script type="module">
    import { supabase, checkAndRestoreSessionFromURL } from './js/auth.js';
    import { SUPABASE_FUNCTION_BASE } from './js/config.js';

    const logs = document.getElementById("logs");
    const link = document.getElementById("pdf-link");
    const downloadLink = document.getElementById("download-link");
    const textOutput = document.getElementById("text-output");

    const log = (msg) => {
      logs.textContent += `\n${msg}`;
      logs.scrollTop = logs.scrollHeight;
    };

    async function run() {
      try {
        log("[ğŸ”] Connexion en cours...");
        await checkAndRestoreSessionFromURL();

        const { data: { user }, error } = await supabase.auth.getUser();
        if (!user || error) {
          log("[âŒ] Utilisateur non connectÃ©.");
          return;
        }

        const session = await supabase.auth.getSession();
        const token = session.data.session.access_token;

        if (!token) {
          log("[âŒ] Token Supabase introuvable.");
          return;
        }

        log("[ğŸ‘¤] Utilisateur connectÃ©.");
        log("[ğŸ›°] RÃ©cupÃ©ration des donnÃ©es pharmacieâ€¦");

        const record = await fetch(`${SUPABASE_FUNCTION_BASE}/get-pharmacie`, {
          headers: { Authorization: `Bearer ${token}` }
        }).then(r => r.json());

        const fields = record?.records?.[0]?.fields;
        if (!fields) {
          log("[âŒ] DonnÃ©es pharmacie introuvables.");
          return;
        }

        log("[ğŸ“¤] GÃ©nÃ©ration du contrat PDFâ€¦");

        const pdfRes = await fetch(`${SUPABASE_FUNCTION_BASE}/trigger-google-pdf`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ fields })
        });

        const pdfData = await pdfRes.json();

        if (!pdfRes.ok || !pdfData?.success) {
          log("[âŒ] Ã‰chec de la gÃ©nÃ©ration du PDF.");
          return;
        }

        link.href = pdfData.pdfUrl;
        link.style.display = "inline-block";
        log("[âœ…] Contrat gÃ©nÃ©rÃ© avec succÃ¨s !");

        if (pdfData.pdfBase64) {
          const base64 = pdfData.pdfBase64;
          log("[ğŸ“¦] PDF en base64 (extrait) :");
          log(base64.slice(0, 300) + "â€¦");

          // ğŸ’¾ PrÃ©parer le tÃ©lÃ©chargement
          const dataUrl = `data:application/pdf;base64,${base64}`;
          downloadLink.href = dataUrl;
          downloadLink.style.display = "inline-block";

          // ğŸ§¾ Essayer dâ€™extraire du texte lisible
          const decoded = atob(base64);
          const readableText = decoded.replace(/[^\x20-\x7E\n\r]+/g, ""); // filtre les caractÃ¨res non imprimables
          textOutput.textContent = readableText.slice(0, 3000) + (readableText.length > 3000 ? "â€¦" : "");
        } else {
          textOutput.textContent = "[âš ï¸] Aucune donnÃ©e base64 reÃ§ue.";
        }

      } catch (err) {
        log("[ğŸ”¥] Erreur inattendue : " + err.message);
        console.error(err);
      }
    }

    run();
  </script>
</body>
</html>
