<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Contrat √† signer</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    iframe { width: 100%; height: 600px; border: none; margin-top: 2rem; }
  </style>
</head>
<body>
  <h1>Signature du contrat</h1>
  <div id="status">Chargement...</div>
  <button id="signBtn" style="margin-top:1rem;">Signer le contrat</button>
  <div id="iframeContainer"></div>

  <script type="module">
    import { supabase, checkAndRestoreSessionFromURL } from './js/auth.js';
    import { SUPABASE_FUNCTION_BASE } from './js/config.js';

    const statusEl = document.getElementById("status");
    const signBtn = document.getElementById("signBtn");
    const iframeContainer = document.getElementById("iframeContainer");

    let user = null;
    let token = "";
    let record = null;

    async function getUserAndPharmacie() {
      await checkAndRestoreSessionFromURL();

      const { data: authData } = await supabase.auth.getUser();
      user = authData.user;
      if (!user) {
        statusEl.textContent = "‚ùå Non connect√©.";
        return;
      }

      console.log("üë§ Utilisateur connect√© :", user);
      console.log("üìß Email utilisateur :", user.email);

      statusEl.innerHTML = `‚úÖ Connect√© : <strong>${user.email}</strong>`;

      const session = await supabase.auth.getSession();
      token = session.data.session.access_token;

      const res = await fetch(`${SUPABASE_FUNCTION_BASE}/get-pharmacie`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      const json = await res.json();
      record = json.records?.[0];

      if (!record) {
        statusEl.textContent = "‚ùå Aucune pharmacie trouv√©e.";
        signBtn.disabled = true;
      } else {
        console.log("üè• Fiche pharmacie :", record.fields);
      }
    }

    signBtn.addEventListener("click", async () => {
      if (!record || !user?.email) {
        statusEl.textContent = "‚ùå Informations manquantes pour signer.";
        return;
      }

      const htmlContent = `
        <h1>Contrat de partenariat</h1>
        <p>Entre la soci√©t√© <strong>Nexum</strong> et la pharmacie :</p>
        <p><strong>${record.fields["Raison sociale"]}</strong></p>
        <p>${record.fields["Adresse"]}, ${record.fields["Code postal"]} ${record.fields["Ville"]}</p>
        <p>SIREN : ${record.fields["RCS (SIREN)"]}</p>
        <p>Le pr√©sent contrat engage les parties √† collaborer dans le cadre du programme de services propos√©s par Nexum.</p>
        <p>Fait √† Paris, le ${new Date().toLocaleDateString("fr-FR")}</p>
        <p>Signature du pharmacien :</p>
      `;

      const payload = {
        nom: record.fields["Raison sociale"],
        email: user.email,
        htmlContent
      };

      console.log("üì§ Envoi √† create-signature :", payload);

      const res = await fetch(`${SUPABASE_FUNCTION_BASE}/create-signature`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (res.ok && data.iframe_url) {
        statusEl.textContent = "‚úÖ Contrat g√©n√©r√©. Vous pouvez signer ci-dessous.";
        iframeContainer.innerHTML = `<iframe src="${data.iframe_url}" allowfullscreen></iframe>`;
      } else {
        statusEl.textContent = "‚ùå Erreur : " + (data.error || "Inconnue");
        console.error("‚õî D√©tails erreur :", data.details || data);
      }
    });

    await getUserAndPharmacie();
  </script>
</body>
</html>
