<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Signature du contrat</title>
  <style>
    body {
      font-family: monospace;
      padding: 2rem;
      background: #f5f5f5;
    }
    #logs {
      background: #111;
      color: #0f0;
      padding: 1rem;
      border-radius: 6px;
      white-space: pre-wrap;
      height: 70vh;
      overflow-y: auto;
    }
    #pdf-link {
      margin-top: 1rem;
      display: none;
    }
  </style>
</head>
<body>
  <h1>📝 Génération du contrat</h1>
  <div id="logs">[🟢] Initialisation…</div>
  <a id="pdf-link" href="#" target="_blank">📄 Voir le contrat généré</a>

  <script type="module">
    import { supabase, checkAndRestoreSessionFromURL } from './js/auth.js';
    import { SUPABASE_FUNCTION_BASE } from './js/config.js';

    // 🔍 Ajoute supabase au scope global pour devtools
    window.supabase = supabase;

    const logs = document.getElementById("logs");
    const link = document.getElementById("pdf-link");

    const log = (msg) => {
      logs.textContent += `\n${msg}`;
      logs.scrollTop = logs.scrollHeight;
      console.log(msg); // aussi dans la console
    };

    async function run() {
      try {
        log("[🔐] Connexion en cours...");
        await checkAndRestoreSessionFromURL();

        const { data: { user }, error } = await supabase.auth.getUser();
        if (!user || error) {
          log("[❌] Utilisateur non connecté.");
          return;
        }

        const session = await supabase.auth.getSession();
        const token = session.data.session.access_token;

        if (!token) {
          log("[❌] Token Supabase introuvable.");
          return;
        }

        // 🔐 Affiche le token dans la console pour test
        console.log("🔑 Token Supabase :", token);

        log(`[👤] Connecté en tant que ${user.email}`);
        log("[🛰] Récupération des données pharmacie…");

        const record = await fetch(`${SUPABASE_FUNCTION_BASE}/get-pharmacie`, {
          headers: { Authorization: `Bearer ${token}` }
        }).then(r => r.json());

        const fields = record?.records?.[0]?.fields;
        if (!fields) {
          log("[❌] Données pharmacie introuvables.");
          return;
        }

        log("[🧪 JSON envoyé] " + JSON.stringify(fields, null, 2));

        log("[📤] Envoi des données à trigger-google-pdf…");
        const res = await fetch(`${SUPABASE_FUNCTION_BASE}/trigger-google-pdf`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ fields })
        });

        const data = await res.json();

        if (res.ok && data?.success) {
          log("[✅] Contrat généré avec succès !");
          log(`[📄] ID PDF : ${data.pdfFileId}`);
          log(`[🔗] URL : ${data.pdfUrl}`);

          link.href = data.pdfUrl;
          link.style.display = "inline-block";
          link.textContent = "📄 Voir le contrat généré";
        } else {
          log("[❌] Échec :");
          log(JSON.stringify(data, null, 2));
        }
      } catch (err) {
        log("[🔥] Exception dans run(): " + err.message);
        console.error(err);
      }
    }

    run();
  </script>
</body>
</html>
