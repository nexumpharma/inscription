<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Signature du contrat</title>
  <style>
    body {
      font-family: monospace;
      padding: 2rem;
      background: #f5f5f5;
    }
    #logs {
      background: #111;
      color: #0f0;
      padding: 1rem;
      border-radius: 6px;
      white-space: pre-wrap;
      height: 40vh;
      overflow-y: auto;
    }
    #pdf-link, #sign-button {
      margin-top: 1rem;
      display: none;
    }
    #loading {
      font-style: italic;
      margin-top: 1rem;
    }
    button {
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <h1>üìù G√©n√©ration et signature du contrat</h1>

  <div id="loading">‚è≥ Chargement du lien de signature‚Ä¶</div>
  <a id="sign-button" href="#" target="_blank">
    <button>‚úçÔ∏è Signer le contrat</button>
  </a>
  <br>
  <a id="pdf-link" href="#" target="_blank">üìÑ Voir le contrat g√©n√©r√©</a>
  <div id="logs">[üü¢] Initialisation‚Ä¶</div>

  <script type="module">
    import { supabase, checkAndRestoreSessionFromURL } from './js/auth.js';
    import { SUPABASE_FUNCTION_BASE } from './js/config.js';

    window.supabase = supabase;

    const logs = document.getElementById("logs");
    const pdfLink = document.getElementById("pdf-link");
    const signButton = document.getElementById("sign-button");
    const loadingText = document.getElementById("loading");

    const log = (msg) => {
      logs.textContent += `\n${msg}`;
      logs.scrollTop = logs.scrollHeight;
    };

    async function run() {
      try {
        log("[üîê] Connexion en cours...");
        await checkAndRestoreSessionFromURL();

        const { data: { user }, error } = await supabase.auth.getUser();
        if (!user || error) {
          log("[‚ùå] Utilisateur non connect√©.");
          return;
        }

        const session = await supabase.auth.getSession();
        const token = session.data.session.access_token;

        if (!token) {
          log("[‚ùå] Token Supabase introuvable.");
          return;
        }

        log("[üë§] Utilisateur connect√©.");
        log("[üõ∞] R√©cup√©ration des donn√©es pharmacie‚Ä¶");

        const record = await fetch(`${SUPABASE_FUNCTION_BASE}/get-pharmacie`, {
          headers: { Authorization: `Bearer ${token}` }
        }).then(r => r.json());

        const fields = record?.records?.[0]?.fields;
        if (!fields) {
          log("[‚ùå] Donn√©es pharmacie introuvables.");
          return;
        }

        log("[üì§] G√©n√©ration du contrat PDF‚Ä¶");

        const pdfRes = await fetch(`${SUPABASE_FUNCTION_BASE}/trigger-google-pdf`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ fields })
        });

        const pdfData = await pdfRes.json();

        if (!pdfRes.ok || !pdfData?.success) {
          log("[‚ùå] √âchec de la g√©n√©ration du PDF.");
          return;
        }

        pdfLink.href = pdfData.pdfUrl;
        pdfLink.style.display = "inline-block";
        log("[‚úÖ] Contrat g√©n√©r√© avec succ√®s !");

        if (pdfData.pdfBase64) {
          log("[üìÑ] Donn√©es PDF en base64 re√ßues.");
        } else {
          log("[‚ö†Ô∏è] Aucune donn√©e base64 re√ßue.");
        }

        log("[‚úçÔ∏è] Envoi √† OpenSign pour signature‚Ä¶");

        const recipient = {
          email: fields["Mail du titulaire"] || user.email,
          name: `${fields["Pr√©nom"] || "Titulaire"} ${fields["Nom"] || ""}`.trim(),
          phone: fields["Portable du titulaire"] || ""
        };

        const signRes = await fetch(`${SUPABASE_FUNCTION_BASE}/create-signature-from-pdf`, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            pdfBase64: pdfData.pdfBase64,
            recipient
          })
        });

        const signData = await signRes.json();

        const openSignUrl =
          signData?.iframeUrl ||
          signData?.openSignResponse?.signurl?.[0]?.url ||
          null;

        if (signRes.ok && openSignUrl) {
          log("[‚úÖ] Document pr√™t √† √™tre sign√© !");
          log("[üîó] Lien : " + openSignUrl);

          signButton.href = openSignUrl;
          signButton.style.display = "inline-block";
          loadingText.style.display = "none";

        } else {
          log("[‚ùå] Erreur OpenSign : " + (signData?.error || "Erreur inconnue"));
          if (signData?.openSignResponse) {
            log(JSON.stringify(signData.openSignResponse, null, 2));
          }
          loadingText.textContent = "‚ùå Erreur de chargement du lien de signature.";
        }

      } catch (err) {
        log("[üî•] Erreur inattendue : " + err.message);
        console.error(err);
        loadingText.textContent = "‚ùå Erreur inattendue.";
      }
    }

    run();
  </script>
</body>
</html>
