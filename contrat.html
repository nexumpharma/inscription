<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Contrat à signer</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    iframe { width: 100%; height: 600px; border: none; margin-top: 2rem; }
  </style>
</head>
<body>
  <h1>Signature du contrat</h1>
  <div id="status">Chargement...</div>
  <button id="signBtn" style="margin-top:1rem;">Signer le contrat</button>
  <div id="iframeContainer"></div>

  <script type="module">
    import { supabase, checkAndRestoreSessionFromURL } from './js/auth.js';
    import { SUPABASE_FUNCTION_BASE } from './js/config.js';

    const statusEl = document.getElementById("status");
    const signBtn = document.getElementById("signBtn");
    const iframeContainer = document.getElementById("iframeContainer");

    let user = null;
    let token = "";
    let record = null;

    async function getUserAndPharmacie() {
      await checkAndRestoreSessionFromURL();
      const { data: authData } = await supabase.auth.getUser();
      user = authData.user;
      if (!user) {
        statusEl.textContent = "❌ Non connecté.";
        return;
      }

      statusEl.innerHTML = `✅ Connecté : <strong>${user.email}</strong>`;
      const session = await supabase.auth.getSession();
      token = session.data.session.access_token;

      const res = await fetch(`${SUPABASE_FUNCTION_BASE}/get-pharmacie`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const json = await res.json();
      record = json.records?.[0];

      if (!record) {
        statusEl.textContent = "❌ Aucune pharmacie trouvée.";
        signBtn.disabled = true;
      }
    }

    signBtn.addEventListener("click", async () => {
      if (!record) return;

      const htmlContent = `
        <h1>Contrat de partenariat</h1>
        <p>Entre la société <strong>Nexum</strong> et la pharmacie :</p>
        <p><strong>${record.fields["Raison sociale"]}</strong></p>
        <p>${record.fields["Adresse"]}, ${record.fields["Code postal"]} ${record.fields["Ville"]}</p>
        <p>SIREN : ${record.fields["RCS (SIREN)"]}</p>
        <p>Le présent contrat engage les parties à collaborer dans le cadre du programme de services proposés par Nexum.</p>
        <p>Fait à Paris, le ${new Date().toLocaleDateString("fr-FR")}</p>
        <p>Signature du pharmacien :</p>
      `;

      const res = await fetch(`${SUPABASE_FUNCTION_BASE}/create-signature`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          nom: record.fields["Raison sociale"],
          email: user.email,
          htmlContent
        })
      });

      const data = await res.json();
      if (res.ok && data.iframe_url) {
        statusEl.textContent = "✅ Contrat généré. Vous pouvez signer ci-dessous.";
        iframeContainer.innerHTML = `<iframe src="${data.iframe_url}" allowfullscreen></iframe>`;
      } else {
        statusEl.textContent = "❌ Erreur : " + (data.error || "Inconnue");
        console.error(data.details || data);
      }
    });

    await getUserAndPharmacie();
  </script>
</body>
</html>
