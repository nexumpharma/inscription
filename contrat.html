<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Génération du contrat</title>
  <style>
    body { font-family: monospace; padding: 2rem; }
    #logs {
      background: #111; color: #0f0;
      padding: 1rem; border-radius: 6px;
      white-space: pre-wrap;
      height: 70vh; overflow-y: auto;
    }
    #pdf-link { margin-top: 1rem; display: block; }
  </style>
</head>
<body>

  <h1>📝 Génération du contrat</h1>
  <div id="logs">[🟢] Initialisation…</div>
  <a id="pdf-link" href="#" target="_blank" style="display:none;">📄 Ouvrir le contrat généré</a>

  <script type="module">
    import { supabase, checkAndRestoreSessionFromURL } from './js/auth.js';
    import { SUPABASE_FUNCTION_BASE } from './js/config.js';

    const logs = document.getElementById("logs");
    const link = document.getElementById("pdf-link");

    const log = (msg) => {
      logs.textContent += `\n${msg}`;
      logs.scrollTop = logs.scrollHeight;
    };

    async function run() {
      log("[🔐] Connexion en cours...");
      await checkAndRestoreSessionFromURL();

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        log("[❌] Non connecté.");
        return;
      }

      const session = await supabase.auth.getSession();
      const token = session.data.session.access_token;

      log(`[👤] Connecté en tant que ${user.email}`);
      log("[📡] Récupération des données pharmacie…");

      const record = await fetch(`${SUPABASE_FUNCTION_BASE}/get-pharmacie`, {
        headers: { Authorization: `Bearer ${token}` }
      }).then(r => r.json());

      const fields = record?.records?.[0]?.fields;
      if (!fields) {
        log("[❌] Données introuvables.");
        return;
      }

      log("[📤] Envoi des données à la fonction generate-pdf…");

      const res = await fetch(`${SUPABASE_FUNCTION_BASE}/generate-pdf`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ fields })
      });

      const data = await res.json();

      if (res.ok) {
        log("[✅] Contrat généré avec succès !");
        log(`[📄] ID PDF : ${data.pdfFileId}`);
        log(`[🔗] Lien PDF : ${data.pdfUrl}`);
        link.href = data.pdfUrl;
        link.style.display = "inline-block";
        link.textContent = "📄 Ouvrir le contrat généré";
      } else {
        log("[❌] Erreur : " + (data.error || "Erreur inconnue."));
      }
    }

    run();
  </script>

</body>
</html>
