<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Contrat √† signer</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; max-width: 800px; }
    h1 { margin-bottom: 1rem; }
    .contract { border: 1px solid #ccc; padding: 2rem; border-radius: 8px; background: #f9f9f9; }
    .signature-block { margin-top: 2rem; }
    .btn-sign { padding: 10px 20px; font-size: 1rem; background: #007BFF; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .btn-sign:hover { background: #0056b3; }
    .info { color: green; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>Contrat de collaboration</h1>
  <div id="status">Chargement des informations...</div>

  <div id="contractContainer" style="display:none;">
    <div class="contract" id="contractText">
      <p>Entre les soussign√©s :</p>
      <p>
        <strong><span id="pharmaNom">[Nom]</span></strong>, situ√© au 
        <strong><span id="pharmaAdresse">[Adresse]</span></strong>, SIRET 
        <strong><span id="pharmaSiret">[SIRET]</span></strong>,
        ci-apr√®s d√©sign√© ‚Äúle Pharmacien‚Äù.
      </p>

      <p>Et la soci√©t√© <strong>Nexum Pharma</strong>, dont le si√®ge social est situ√© √† ..., ci-apr√®s d√©nomm√©e ‚Äúla Soci√©t√©‚Äù.</p>

      <p>Les parties conviennent de collaborer selon les termes suivants :</p>
      <ul>
        <li>Le Pharmacien s'engage √† ...</li>
        <li>La Soci√©t√© s'engage √† ...</li>
        <li>Dur√©e du contrat : 12 mois renouvelables</li>
        <li>Conditions financi√®res : ...</li>
      </ul>

      <p>Fait √† Paris, le <span id="dateSignature"></span></p>

      <div class="signature-block">
        <button class="btn-sign" id="signBtn">Signer √©lectroniquement</button>
        <div class="info" id="signedInfo" style="display:none;">üìÑ Le contrat est pr√™t √† √™tre sign√©.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase, checkAndRestoreSessionFromURL, logout } from './js/auth.js';
    import { SUPABASE_FUNCTION_BASE } from './js/config.js';

    let token = "";
    let record = null;

    const status = document.getElementById("status");
    const container = document.getElementById("contractContainer");

    async function loadPharmacieData() {
      await checkAndRestoreSessionFromURL();
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        status.textContent = "‚ùå Utilisateur non connect√©.";
        return;
      }

      const session = await supabase.auth.getSession();
      token = session.data.session.access_token;

      const res = await fetch(`${SUPABASE_FUNCTION_BASE}/get-pharmacie`, {
        headers: { Authorization: `Bearer ${token}` }
      });

      const json = await res.json();
      record = json.records?.[0];
      if (!record) {
        status.textContent = "‚ùå Aucune fiche pharmacie trouv√©e.";
        return;
      }

      // Injecter les donn√©es dans le contrat
      document.getElementById("pharmaNom").textContent = record.fields["Nom pharmacie"] || "[Nom]";
      document.getElementById("pharmaAdresse").textContent = record.fields["Adresse compl√®te"] || "[Adresse]";
      document.getElementById("pharmaSiret").textContent = record.fields["SIRET"] || "[SIRET]";
      document.getElementById("dateSignature").textContent = new Date().toLocaleDateString("fr-FR");

      status.innerHTML = `‚úÖ Connect√© en tant que <strong>${user.email}</strong>`;
      container.style.display = "block";
    }

    document.getElementById("signBtn").addEventListener("click", async () => {
      // Exemple simple ‚Äî en r√©alit√© tu appellerais OpenSign ici
      document.getElementById("signedInfo").style.display = "block";

      // Option : sauvegarder le fait que le contrat a √©t√© sign√© dans Airtable
      await fetch(`${SUPABASE_FUNCTION_BASE}/update-pharmacie`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          id: record.id,
          fields: {
            "Contrat sign√©": true,
            "Date signature": new Date().toISOString()
          }
        })
      });
    });

    await loadPharmacieData();
  </script>
</body>
</html>
